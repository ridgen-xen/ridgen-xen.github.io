<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Physics Formula Deck</title>

  <!-- KaTeX (—Ä–µ–Ω–¥–µ—Ä —Ñ–æ—Ä–º—É–ª LaTeX) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --stroke: rgba(255,255,255,.12);
      --accent: #7c5cff;
      --accent2:#22c55e;

      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 22px;
    }

    [data-theme="light"]{
      --bg:#f6f7fb;
      --panel: rgba(10,15,25,.05);
      --panel2: rgba(10,15,25,.08);
      --text: rgba(10,15,25,.92);
      --muted: rgba(10,15,25,.70);
      --muted2: rgba(10,15,25,.55);
      --stroke: rgba(10,15,25,.12);
      --accent: #5b5bff;
      --accent2:#16a34a;
      --shadow: 0 18px 55px rgba(10,15,25,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(1000px 650px at 90% 0%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 700px at 70% 85%, rgba(124,92,255,.18), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    a{color:inherit}
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom: 18px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .title{
      font-size: 26px;
      letter-spacing:-.02em;
      margin:0;
      line-height:1.1;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 14px;
      line-height:1.35;
      max-width: 62ch;
    }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      font-weight:600;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(124,92,255,.45);}
    .btn:active{ transform: translateY(0px); }

    .btn.primary{
      border-color: rgba(124,92,255,.45);
      background: linear-gradient(180deg, rgba(124,92,255,.28), rgba(255,255,255,.04));
    }

    .btn.good{
      border-color: rgba(34,197,94,.45);
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(255,255,255,.04));
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 13px;
      box-shadow: 0 10px 28px rgba(0,0,0,.10);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: start;
      margin-top: 14px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction:column; align-items:stretch;}
      .top-actions{ justify-content:flex-start;}
    }

    .panel{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panel-head{
      padding: 14px 16px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .panel-head h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.02em;
      color: var(--muted);
      font-weight:800;
      text-transform: uppercase;
    }

    .panel-body{ padding: 14px 16px; }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 10px;
    }
    @media (max-width: 600px){
      .controls{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    input, textarea, select{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline: none;
      box-shadow: 0 12px 30px rgba(0,0,0,.08) inset;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: var(--muted2); }
    select{ cursor:pointer; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 700px){
      .cards{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius2);
      box-shadow: 0 18px 55px rgba(0,0,0,.20);
      overflow:hidden;
      position:relative;
    }

    .card-top{
      padding: 14px 14px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .card-title{
      margin:0;
      font-size: 15px;
      font-weight: 850;
      letter-spacing:-.01em;
      line-height:1.25;
    }
    .topic{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .formula{
      padding: 2px 14px 14px;
      font-size: 20px;
      overflow-x:auto;
    }

    .note{
      padding: 0 14px 14px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
    }

    .card-bottom{
      border-top:1px solid var(--stroke);
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .mini{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted2);
      font-size: 12px;
    }

    .tag{
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight: 700;
    }

    .icon{
      width:16px;height:16px;display:inline-block;opacity:.85
    }

    .learned-badge{
      position:absolute;
      top: 10px;
      right: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34,197,94,.16);
      border: 1px solid rgba(34,197,94,.35);
      color: rgba(34,197,94,.95);
      font-weight: 900;
      font-size: 12px;
      display:none;
    }
    .card.learned .learned-badge{ display:block; }

    .empty{
      color: var(--muted);
      font-size: 14px;
      padding: 12px 2px;
    }

    .footer{
      margin-top: 18px;
      color: var(--muted2);
      font-size: 12px;
      line-height:1.45;
    }

    .kbd{
      border: 1px solid var(--stroke);
      border-bottom-width: 2px;
      padding: 2px 7px;
      border-radius: 8px;
      background: rgba(255,255,255,.04);
      font-weight: 800;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1 class="title">Physics Formula Deck</h1>
        <p class="subtitle">
          –î–æ–±–∞–≤–ª—è–π —Ñ–æ—Ä–º—É–ª—ã –≤ LaTeX ‚Äî —Å–∞–π—Ç –∫—Ä–∞—Å–∏–≤–æ –∏—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç. –ï—Å—Ç—å –ø–æ–∏—Å–∫, —Ç–µ–º—ã –∏ –æ—Ç–º–µ—Ç–∫–∞ ¬´–≤—ã—É—á–µ–Ω–æ¬ª.
          –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <span class="kbd">localStorage</span> (–≤ –±—Ä–∞—É–∑–µ—Ä–µ).
        </p>
      </div>

      <div class="top-actions">
        <span id="stats" class="pill">0 —Ñ–æ—Ä–º—É–ª ‚Ä¢ 0 –≤—ã—É—á–µ–Ω–æ</span>
        <button class="btn" id="toggleTheme" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô –¢–µ–º–∞</button>
        <button class="btn" id="exportBtn" title="–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã –≤ JSON">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</button>
        <label class="btn" title="–ò–º–ø–æ—Ä—Ç JSON">
          ‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç
          <input id="importFile" type="file" accept="application/json" hidden />
        </label>
        <button class="btn primary" id="seedBtn" title="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã">‚ú® –ü—Ä–∏–º–µ—Ä—ã</button>
      </div>
    </header>

    <div class="grid">
      <!-- –õ–ï–í–û: —Å–ø–∏—Å–æ–∫ -->
      <section class="panel">
        <div class="panel-head">
          <h2>–§–æ—Ä–º—É–ª—ã</h2>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select id="topicFilter" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–º–µ">
              <option value="">–í—Å–µ —Ç–µ–º—ã</option>
            </select>
            <input id="search" type="search" placeholder="–ü–æ–∏—Å–∫: —Å–ª–æ–≤–æ, —Ç–µ–º–∞, LaTeX‚Ä¶" aria-label="–ü–æ–∏—Å–∫" />
          </div>
        </div>
        <div class="panel-body">
          <div id="cards" class="cards"></div>
          <div id="empty" class="empty" style="display:none;">
            –ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å —Ñ–æ—Ä–º—É–ª—É —Å–ø—Ä–∞–≤–∞ ‚ûú
          </div>

          <div class="footer">
            –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ LaTeX: <span class="kbd">\frac{a}{b}</span>, <span class="kbd">\sqrt{x}</span>,
            <span class="kbd">v_0</span>, <span class="kbd">a^2</span>, <span class="kbd">\vec{F}</span>.
          </div>
        </div>
      </section>

      <!-- –ü–†–ê–í–û: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
      <aside class="panel">
        <div class="panel-head">
          <h2>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É</h2>
        </div>
        <div class="panel-body">
          <div class="controls">
            <div class="field">
              <div class="label">–¢–µ–º–∞</div>
              <input id="topic" placeholder="–ù–∞–ø—Ä. –î–∏–Ω–∞–º–∏–∫–∞ / –ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞" />
            </div>
            <div class="field">
              <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
              <input id="title" placeholder="–ù–∞–ø—Ä. 2 –∑–∞–∫–æ–Ω –ù—å—é—Ç–æ–Ω–∞" />
            </div>
          </div>

          <div class="field" style="margin-top:10px;">
            <div class="label">–§–æ—Ä–º—É–ª–∞ (LaTeX)</div>
            <input id="latex" placeholder="–ù–∞–ø—Ä. F = ma –∏–ª–∏ E_k = \frac{mv^2}{2}" />
          </div>

          <div class="field" style="margin-top:10px;">
            <div class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
            <textarea id="note" placeholder="–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è‚Ä¶"></textarea>
          </div>

          <div class="field" style="margin-top:10px;">
            <div class="label">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</div>
            <input id="tags" placeholder="–Ω–∞–ø—Ä. –Ω—å—é—Ç–æ–Ω, —Å–∏–ª–∞, —É—Å–∫–æ—Ä–µ–Ω–∏–µ" />
          </div>

          <div class="row">
            <button class="btn primary" id="addBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn" id="clearForm">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn" id="wipeAll" title="–£–¥–∞–ª–∏—Ç –≤—Å–µ —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞">üóëÔ∏è –°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë</button>
          </div>

          <div class="panel" style="margin-top:14px;">
            <div class="panel-head">
              <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
            </div>
            <div class="panel-body">
              <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
                <div>
                  <div id="previewTitle" style="font-weight:900; font-size:14px; margin-bottom:6px; color:var(--text);">‚Äî</div>
                  <div id="previewTopic" class="tag" style="display:inline-flex;">‚Äî</div>
                </div>
              </div>
              <div id="previewFormula" class="formula" style="padding-left:0; padding-right:0;">‚Äî</div>
              <div id="previewNote" class="note" style="padding-left:0; padding-right:0; margin:0;">‚Äî</div>
            </div>
          </div>

        </div>
      </aside>
    </div>
  </div>

  <script>
    // ----------------------------
    // Storage helpers
    // ----------------------------
    const KEY = "physics_formulas_v1";
    const THEME_KEY = "physics_theme_v1";

    function loadData(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        return [];
      }
    }
    function saveData(items){
      localStorage.setItem(KEY, JSON.stringify(items));
    }

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    // ----------------------------
    // State
    // ----------------------------
    let items = loadData();

    const elCards = document.getElementById("cards");
    const elEmpty = document.getElementById("empty");
    const elSearch = document.getElementById("search");
    const elTopicFilter = document.getElementById("topicFilter");
    const elStats = document.getElementById("stats");

    const fTopic = document.getElementById("topic");
    const fTitle = document.getElementById("title");
    const fLatex = document.getElementById("latex");
    const fNote = document.getElementById("note");
    const fTags = document.getElementById("tags");

    const pTitle = document.getElementById("previewTitle");
    const pTopic = document.getElementById("previewTopic");
    const pFormula = document.getElementById("previewFormula");
    const pNote = document.getElementById("previewNote");

    // ----------------------------
    // Theme
    // ----------------------------
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      document.getElementById("toggleTheme").textContent = (theme === "light") ? "üåô –¢–µ–º–∞" : "‚òÄÔ∏è –¢–µ–º–∞";
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved){
        applyTheme(saved);
      }else{
        // –∞–≤—Ç–æ –ø–æ —Å–∏—Å—Ç–µ–º–µ
        const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        applyTheme(prefersLight ? "light" : "dark");
      }
    }

    // ----------------------------
    // KaTeX render
    // ----------------------------
    function renderKatexIn(node){
      // KaTeX auto-render needs to be available (loaded by defer).
      if(typeof renderMathInElement !== "function") return;
      renderMathInElement(node, {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "$", right: "$", display: false }
        ],
        throwOnError: false
      });
    }

    function setFormulaHTML(container, latex){
      // We render inline by placing $...$
      container.textContent = ""; // clear
      const span = document.createElement("span");
      span.textContent = `$${latex}$`;
      container.appendChild(span);
      renderKatexIn(container);
    }

    // ----------------------------
    // UI render
    // ----------------------------
    function normalize(s){ return (s||"").toString().toLowerCase().trim(); }

    function getTopics(list){
      const set = new Set();
      list.forEach(it => {
        if(it.topic && it.topic.trim()) set.add(it.topic.trim());
      });
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'ru'));
    }

    function updateTopicFilter(){
      const topics = getTopics(items);
      const current = elTopicFilter.value;

      elTopicFilter.innerHTML = `<option value="">–í—Å–µ —Ç–µ–º—ã</option>` + topics.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      // restore selection if possible
      if(topics.includes(current)) elTopicFilter.value = current;
    }

    function updateStats(){
      const learned = items.filter(x=>x.learned).length;
      elStats.textContent = `${items.length} —Ñ–æ—Ä–º—É–ª ‚Ä¢ ${learned} –≤—ã—É—á–µ–Ω–æ`;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function matchesFilter(it){
      const q = normalize(elSearch.value);
      const tf = elTopicFilter.value;

      if(tf && (it.topic||"").trim() !== tf) return false;

      if(!q) return true;

      const hay = [
        it.title, it.topic, it.latex, it.note,
        (it.tags||[]).join(" ")
      ].map(normalize).join(" | ");

      return hay.includes(q);
    }

    function render(){
      updateTopicFilter();
      updateStats();

      const filtered = items.filter(matchesFilter);

      elCards.innerHTML = "";
      elEmpty.style.display = filtered.length ? "none" : "block";

      filtered.forEach(it => {
        const card = document.createElement("div");
        card.className = "card" + (it.learned ? " learned" : "");

        const tags = (it.tags||[]).slice(0,4);
        const more = (it.tags||[]).length > 4 ? `+${(it.tags||[]).length - 4}` : "";

        card.innerHTML = `
          <div class="learned-badge">‚úî –≤—ã—É—á–µ–Ω–æ</div>

          <div class="card-top">
            <div>
              <div class="card-title">${escapeHtml(it.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</div>
            </div>
            <div class="topic">${escapeHtml(it.topic || "–ë–µ–∑ —Ç–µ–º—ã")}</div>
          </div>

          <div class="formula" data-formula></div>

          ${it.note ? `<div class="note">${escapeHtml(it.note)}</div>` : `<div class="note" style="display:none;"></div>`}

          <div class="card-bottom">
            <div class="mini">
              ${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}
              ${more ? `<span class="tag">${more}</span>` : ""}
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="btn good" data-toggle="${it.id}">‚úÖ –í—ã—É—á–∏–ª</button>
              <button class="btn" data-del="${it.id}">üóëÔ∏è</button>
            </div>
          </div>
        `;

        elCards.appendChild(card);

        const formulaNode = card.querySelector('[data-formula]');
        setFormulaHTML(formulaNode, it.latex || "");
      });

      // attach events
      elCards.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-toggle");
          const idx = items.findIndex(x=>x.id===id);
          if(idx>=0){
            items[idx].learned = !items[idx].learned;
            saveData(items);
            render();
          }
        });
      });

      elCards.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del");
          items = items.filter(x=>x.id!==id);
          saveData(items);
          render();
        });
      });
    }

    // ----------------------------
    // Form + preview
    // ----------------------------
    function updatePreview(){
      pTitle.textContent = fTitle.value.trim() || "‚Äî";
      pTopic.textContent = fTopic.value.trim() || "‚Äî";

      const latex = fLatex.value.trim();
      if(latex){
        setFormulaHTML(pFormula, latex);
      }else{
        pFormula.textContent = "‚Äî";
      }

      const note = fNote.value.trim();
      pNote.textContent = note || "‚Äî";
      pNote.style.opacity = note ? "1" : ".75";
    }

    function clearForm(){
      fTopic.value = "";
      fTitle.value = "";
      fLatex.value = "";
      fNote.value = "";
      fTags.value = "";
      updatePreview();
      fTitle.focus();
    }

    function addFormula(){
      const topic = fTopic.value.trim();
      const title = fTitle.value.trim();
      const latex = fLatex.value.trim();
      const note = fNote.value.trim();
      const tags = fTags.value.split(",").map(s=>s.trim()).filter(Boolean);

      if(!latex){
        alert("–í—Å—Ç–∞–≤—å LaTeX —Ñ–æ—Ä–º—É–ª—É –≤ –ø–æ–ª–µ ¬´–§–æ—Ä–º—É–ª–∞¬ª.");
        fLatex.focus();
        return;
      }

      items.unshift({
        id: uid(),
        topic: topic || "–ë–µ–∑ —Ç–µ–º—ã",
        title: title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
        latex,
        note,
        tags,
        learned: false,
        createdAt: Date.now()
      });

      saveData(items);
      clearForm();
      render();
    }

    // ----------------------------
    // Export / Import
    // ----------------------------
    function exportJSON(){
      const blob = new Blob([JSON.stringify(items, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "physics_formulas.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const parsed = JSON.parse(reader.result);
          if(!Array.isArray(parsed)) throw new Error("JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");
          // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
          const cleaned = parsed.map(x => ({
            id: x.id || uid(),
            topic: (x.topic || "–ë–µ–∑ —Ç–µ–º—ã").toString(),
            title: (x.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è").toString(),
            latex: (x.latex || "").toString(),
            note: (x.note || "").toString(),
            tags: Array.isArray(x.tags) ? x.tags.map(t=>String(t)) : [],
            learned: !!x.learned,
            createdAt: x.createdAt || Date.now()
          })).filter(x=>x.latex.trim().length>0);

          // –º–µ—Ä–¥–∂: –¥–æ–±–∞–≤–∏–º —Å–≤–µ—Ä—Ö—É, –±–µ–∑ –¥—É–±–ª–µ–π –ø–æ id
          const existing = new Set(items.map(x=>x.id));
          const merged = [...cleaned.filter(x=>!existing.has(x.id)), ...items];
          items = merged;
          saveData(items);
          render();
        }catch(e){
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON: " + e.message);
        }
      };
      reader.readAsText(file);
    }

    // ----------------------------
    // Seed examples
    // ----------------------------
    function seedExamples(){
      const examples = [
        {topic:"–î–∏–Ω–∞–º–∏–∫–∞", title:"2 –∑–∞–∫–æ–Ω –ù—å—é—Ç–æ–Ω–∞", latex:"\\vec{F}=m\\vec{a}", note:"–°–≤—è–∑—å —Å–∏–ª—ã –∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è", tags:["—Å–∏–ª–∞","–Ω—å—é—Ç–æ–Ω"]},
        {topic:"–ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞", title:"–†–∞–≤–Ω–æ–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ", latex:"v = v_0 + at", note:"–°–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–º —É—Å–∫–æ—Ä–µ–Ω–∏–∏", tags:["—Å–∫–æ—Ä–æ—Å—Ç—å","—É—Å–∫–æ—Ä–µ–Ω–∏–µ"]},
        {topic:"–≠–Ω–µ—Ä–≥–∏—è", title:"–ö–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è", latex:"E_k=\\frac{mv^2}{2}", note:"–≠–Ω–µ—Ä–≥–∏—è –¥–≤–∏–∂–µ–Ω–∏—è —Ç–µ–ª–∞", tags:["—ç–Ω–µ—Ä–≥–∏—è"]},
        {topic:"–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", title:"–ó–∞–∫–æ–Ω –û–º–∞", latex:"I=\\frac{U}{R}", note:"–¢–æ–∫ —á–µ—Ä–µ–∑ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ", tags:["–æ–º","—Ç–æ–∫"]},
      ].map(x=>({id:uid(), learned:false, createdAt:Date.now(), ...x}));

      items = [...examples, ...items];
      saveData(items);
      render();
    }

    // ----------------------------
    // Events
    // ----------------------------
    document.getElementById("addBtn").addEventListener("click", addFormula);
    document.getElementById("clearForm").addEventListener("click", clearForm);

    document.getElementById("wipeAll").addEventListener("click", ()=>{
      if(confirm("–¢–æ—á–Ω–æ —Å—Ç–µ—Ä–µ—Ç—å –≤—Å–µ —Ñ–æ—Ä–º—É–ª—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞.")){
        items = [];
        saveData(items);
        render();
      }
    });

    document.getElementById("exportBtn").addEventListener("click", exportJSON);

    document.getElementById("importFile").addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      if(file) importJSON(file);
      e.target.value = "";
    });

    document.getElementById("seedBtn").addEventListener("click", seedExamples);

    document.getElementById("toggleTheme").addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(current === "dark" ? "light" : "dark");
    });

    [elSearch, elTopicFilter].forEach(el => el.addEventListener("input", render));

    // live preview
    [fTopic, fTitle, fLatex, fNote, fTags].forEach(el => el.addEventListener("input", updatePreview));

    // hotkeys
    document.addEventListener("keydown", (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "enter"){
        addFormula();
      }
    });

    // ----------------------------
    // Init
    // ----------------------------
    initTheme();

    // First render after KaTeX scripts load
    window.addEventListener("load", ()=>{
      updatePreview();
      render();
    });
  </script>
</body>
</html>
